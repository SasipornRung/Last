<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PropDecoded • Investor Lens</title>

  <!-- Leaflet + Heat -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root{
      --green:#1F6F63; --green-700:#0E3F38; --green-600:#15574E; --green-100:#E9F6F0;
      --ink:#163330; --muted:#6A7D80; --card:#FFFFFF; --bg:#0F2E29;
      --line:#E6EEEC; --shadow:0 8px 26px rgba(12,35,31,.12);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial;
         color:#132; background:#F7FBFA}
    .wrap{max-width:1080px; margin:auto; padding:24px 16px}
    header{display:flex; align-items:center; gap:10px; margin:6px 0 18px}
    header .brand{display:inline-flex; align-items:center; gap:10px; font-weight:800}
    header .badge{background:var(--green-100); color:var(--green);
                  font-weight:700; padding:6px 10px; border-radius:999px}
    header small{color:var(--muted)}

    /* 2-column layout */
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }

    .card{background:var(--card); border:1px solid var(--line);
          border-radius:16px; box-shadow:var(--shadow)}
    .card .head{padding:12px 14px; border-bottom:1px solid var(--line);
                display:flex; align-items:center; gap:12px; justify-content:space-between}
    .card .body{padding:14px}

    /* map block */
    #il-map{height:420px; border-radius:12px; overflow:hidden}
    .map-controls{display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap}
    select, input[type="search"], button{
      border:1px solid var(--line); border-radius:999px; padding:10px 12px; font-weight:600;
      background:#fff
    }
    button{background:var(--green-600); color:#fff; border:0}
    button:disabled{opacity:.5}
    .chip-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:#fff}
    .chip b{color:var(--green-600)}

    /* slide dots (iPhone style page dots) */
    .dots{display:flex; gap:8px; align-items:center}
    .dot{width:26px; height:6px; border-radius:999px; background:#DBE7E4; opacity:.8}
    .dot.active{background:var(--green-600); opacity:1}

    /* right panel text */
    h3{margin:8px 0 10px} h4{margin:8px 0}
    ul{margin:8px 0 2px 18px; line-height:1.55}
    .help{color:var(--muted); font-size:.92rem}

    /* labels on map */
    .area-label{
      background:#fff; padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      font-weight:800; box-shadow:var(--shadow); color:#222
    }
  </style>
</head>
<body>
  <div class="wrap" id="investorLens">
    <header>
      <span class="badge">PD</span>
      <div class="brand">PropDecoded • Investor Lens</div>
      <small>Heat Map + KPI + Slides</small>
    </header>

    <div class="grid">
      <!-- Left: MAP -->
      <section class="card">
        <div class="head">
          <div class="map-controls">
            <select id="areaSelect" aria-label="เลือกย่าน">
              <option value="sukhumvit">Sukhumvit</option>
              <option value="ekkamai">Ekkamai</option>
              <option value="thonglor">Thonglor</option>
              <option value="onnut">On Nut</option>
              <option value="ratchada">Ratchada</option>
            </select>
            <input id="q" type="search" placeholder="ค้นหาย่าน เช่น Sukhumvit" />
            <button id="goBtn">เลือก</button>
          </div>
          <div class="dots" id="dots">
            <div class="dot active" data-i="0"></div>
            <div class="dot" data-i="1"></div>
            <div class="dot" data-i="2"></div>
            <div class="dot" data-i="3"></div>
          </div>
        </div>
        <div class="body">
          <div id="il-map"></div>
        </div>
      </section>

      <!-- Right: INFO / SLIDE TEXT -->
      <aside class="card">
        <div class="head">
          <div class="chip-row">
            <div class="chip">Yield (คำนวณ) <b id="kpiYield">—</b></div>
            <div class="chip">Cap Rate (คำนวณ) <b id="kpiCap">—</b></div>
          </div>
        </div>
        <div class="body">
          <h3 id="panelTitle">วิธีอ่าน Heat Map</h3>
          <ul id="panelList">
            <li>สีเข้ม = ความหนาแน่นกิจกรรมสูง</li>
            <li>สีอ่อน = ความหนาแน่นต่ำ</li>
            <li>ค้นหาย่าน แล้วกด “เลือก” เพื่อซูม</li>
          </ul>
          <p class="help" id="panelHint">สไลด์ 1/4 • ปัด/คลิกจุดด้านบนเพื่อเปลี่ยนสไลด์</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
  // ------- data -------
  const AREAS = {
    sukhumvit : {
      center:[13.7336,100.5760],
      heat:  [[13.732,100.572,0.9],[13.735,100.581,0.8],[13.728,100.583,0.7],[13.739,100.575,0.65]],
      kpi:   {yield:5.6, cap:4.2}
    },
    ekkamai  : {
      center:[13.7249,100.5860],
      heat:  [[13.724,100.585,0.85],[13.726,100.587,0.7],[13.723,100.589,0.6]],
      kpi:   {yield:5.4, cap:4.1}
    },
    thonglor : {
      center:[13.7296,100.5782],
      heat:  [[13.729,100.576,0.75],[13.731,100.579,0.7],[13.728,100.580,0.55]],
      kpi:   {yield:5.8, cap:4.3}
    },
    onnut    : {
      center:[13.7059,100.6055],
      heat:  [[13.705,100.603,0.6],[13.707,100.606,0.55],[13.703,100.607,0.5]],
      kpi:   {yield:6.1, cap:4.5}
    },
    ratchada : {
      center:[13.7746,100.5735],
      heat:  [[13.775,100.571,0.7],[13.772,100.575,0.6],[13.777,100.576,0.55]],
      kpi:   {yield:5.2, cap:3.9}
    }
  };

  // slides content (changes right panel)
  const SLIDES = [
    {
      title:'วิธีอ่าน Heat Map',
      bullets:[
        'สีเข้ม = ความหนาแน่นกิจกรรมสูง (ธุรกรรม/ความสนใจ)',
        'สีอ่อน = ความหนาแน่นต่ำ',
        'ค้นหาย่าน แล้วกด “เลือก” เพื่อซูม'
      ]
    },
    {
      title:'Demand & Liquidity',
      bullets:[
        'Take-up Rate = % ยูนิตขายได้ช่วงเปิดตัว',
        'Absorption = ยูนิตขายออกต่อรอบเวลา',
        'Overhang = ยูนิตเหลือขาย'
      ]
    },
    {
      title:'Price Metrics • 10 ปี',
      bullets:[
        'Launch vs Resale: เทรนด์ราคาเปิดโครงการ เทียบราคารีเซล',
        'เพิ่มเส้น Benchmark (ธนารักษ์) ไว้เปรียบเทียบ',
        'ช่องว่างราคาบอก Sentiment และอำนาจต่อรอง'
      ]
    },
    {
      title:'Supply & Rental',
      bullets:[
        'New Projects สะท้อนเม็ดเงิน/ความมั่นใจ',
        'Yield vs Cap Rate เทียบมูลค่าตลาดเชิงเงินสด/ผลตอบแทน',
        'ดูร่วมกับค่าเช่าตลาด และอัตราว่าง'
      ]
    }
  ];

  // ------- map init -------
  let map, heatLayer, labelLayer = L.layerGroup();
  function initMap() {
    if (map) { try { map.remove(); } catch(e){} } // กัน init ซ้ำ
    map = L.map('il-map', { scrollWheelZoom:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    labelLayer.addTo(map);
  }

  // add area labels (clickable)
  function drawLabels() {
    labelLayer.clearLayers();
    const labels = {
      sukhumvit:[13.730,100.575],
      thonglor:[13.728,100.579],
      ekkamai:[13.717,100.588]
    };
    Object.entries(labels).forEach(([k, latlng])=>{
      const icon = L.divIcon({className:'area-label', html:k[0].toUpperCase()+k.slice(1), iconSize:null});
      const m = L.marker(latlng,{icon});
      m.on('click', ()=> setArea(k));
      labelLayer.addLayer(m);
    });
  }

  function setArea(key){
    const a = AREAS[key] || AREAS.sukhumvit;
    map.setView(a.center, 14);
    if (heatLayer) heatLayer.remove();
    heatLayer = L.heatLayer(a.heat, {radius:28, blur:18, maxZoom:17});
    heatLayer.addTo(map);
    // KPIs
    document.getElementById('kpiYield').textContent = a.kpi.yield.toFixed(1)+'%';
    document.getElementById('kpiCap').textContent   = a.kpi.cap.toFixed(1)+'%';
    // remember
    localStorage.setItem('pd_area', key);
  }

  // ------- right panel slides -------
  let currentSlide = 0;
  function renderSlide(i){
    currentSlide = i;
    const s = SLIDES[i];
    document.getElementById('panelTitle').textContent = s.title;
    const ul = document.getElementById('panelList');
    ul.innerHTML = s.bullets.map(t=>`<li>${t}</li>`).join('');
    document.getElementById('panelHint').textContent = `สไลด์ ${i+1}/${SLIDES.length} • คลิกจุดด้านบนเพื่อเปลี่ยนสไลด์`;
    [...document.querySelectorAll('.dot')].forEach(d=>d.classList.toggle('active', +d.dataset.i===i));
  }

  // ------- boot -------
  document.addEventListener('DOMContentLoaded', () => {
    // init map
    initMap();
    drawLabels();

    // area controls
    const sel = document.getElementById('areaSelect');
    const q   = document.getElementById('q');
    const go  = document.getElementById('goBtn');

    go.addEventListener('click', () => {
      const bySelect = sel.value;
      const byText = (q.value||'').toLowerCase().trim();
      const key = (byText && Object.keys(AREAS).find(k=>k.includes(byText))) || bySelect;
      setArea(key);
    });

    // dots
    document.getElementById('dots').addEventListener('click', (e)=>{
      const d = e.target.closest('.dot'); if (!d) return;
      renderSlide(+d.dataset.i);
    });

    // restore last
    const last = localStorage.getItem('pd_area') || 'sukhumvit';
    sel.value = last;
    setArea(last);
    renderSlide(0);
  });
  </script>
</body>
</html>
